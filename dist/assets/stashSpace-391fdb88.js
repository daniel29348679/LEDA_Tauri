import{d as G}from"./pinia-71cafef5.js";import{f as c,e as R,c as z}from"./index-d07dfee2.js";import{b as o}from"./earthApi-baaacd65.js";import{b as s,i as F}from"./@vue-19632928.js";const K=G("stashSpace",()=>{const t=s(!1),u=s(0),$=s(100),m=s(!1),h=s([]),A=s(!1),v=s([]),l=F(()=>v.value[0]??""),S=s(!1),w=F(()=>{const e=h.value.find(a=>a.name===l.value)===void 0;return e&&(d.value=[]),e}),I=F(()=>{const e=h.value.find(a=>a.name===l.value);return(e==null?void 0:e.folder_path)??""}),g=s(""),n=s([]),d=s([]),L=e=>{v.value=e},D=e=>{n.value=e},b=async()=>{t.value=!0;try{const e=await o.api.isLocalApiStashIsLocalGet();if(!e)return;if(e.data.code!==0)throw new Error(`API Error: ${e.data.code}`);m.value=e.data.result.is_local}catch(e){c(`${e}`)}finally{t.value=!1}},f=async()=>{t.value=!0;try{const e=await o.api.getStashListApiStashListGet();if(!e)return;if(e.data.code!==0)throw new Error(`API Error: ${e.data.code}`);h.value=e.data.result.list??[]}catch(e){c(`${e}`)}finally{t.value=!1}},M=async()=>{A.value=!0,await f(),l.value&&await p()},p=async()=>{t.value=!0,n.value=[];try{const e=await o.api.getStashFileListApiStashFilesGet({name:l.value});if(!e)return;if(e.data.code!==0)throw new Error(`API Error: ${e.data.code}`);n.value=e.data.result.files??[],d.value=[{...e.data.result.files[0]}]}catch(e){c(`${e}`)}finally{t.value=!1}return n.value};return{isLocal:m,drawerVisible:A,stashList:h,spaceSelected:v,isNewSpace:w,currentSpace:l,currentFolderPath:I,currentUploadSpace:g,spaceFiles:n,spaceFileFirst:d,loading:t,currentLoading:u,totalLoading:$,isMoved:S,openSpace:M,fetchSpaceIsLocal:b,setSpaceSelectList:L,setSpaceFiles:D,fetchLocationFile:async e=>{const a=e?o.api.seletLocalFileApiStashSeletLocalFilePost:o.api.seletLocalDirApiStashSeletLocalDirPost;t.value=!0;try{const r=await a({name:l.value,title:"選擇檔案"});if(!r)return;if(r.data.code!==0)throw new Error(`API Error: ${r.data.code}`);await p()}catch(r){c(`${r}`)}finally{t.value=!1}},fetchSpaceList:f,fetchSpaceFiles:p,fetchSpaceFirstFile:async e=>{if(e&&!w.value){t.value=!0;try{const a=await o.api.getStashFileFirstApiStashFileFirstGet({name:e});if(!a)return;if(a.data.code!==0)throw new Error(`API Error: ${a.data.code}`);d.value=a.data.result.files??[]}catch(a){c(`${a}`)}finally{t.value=!1}return n.value}},fetchSpaceDestroy:async()=>{t.value=!0;try{const e=await o.api.destroyStashApiStashDestroyDelete({name:l.value});if(!e)return;if(e.data.code!==0)throw new Error(`API Error: ${e.data.code}`);L([]),await f()}catch(e){c(`${e}`)}finally{t.value=!1}},fetchSpaceUpload:async e=>{t.value=!0,u.value=1;try{const r=[];for(let i=0;i<e.length;i+=100)r.push(e.slice(i,i+100));let P=0;for(const i of r){const y=new FormData;for(const E of i){const O=await E.arrayBuffer();y.append("file",new Blob([O]),E.name)}if(y.append("name",l.value),!await R("form","/api/stash/upload",y,"POST",void 0,!0))throw new Error("Response is undefined");P+=i.length,u.value=Math.floor(P/e.length*60)+20}p(),w.value&&await f(),u.value=100}catch(a){u.value=0,c(`${a}`)}finally{t.value=!1}},fetchRemoveFile:async e=>{t.value=!0;try{const a=await o.api.removeFromStashApiStashRemoveDelete({name:l.value,file:e});if(!a)return;if(a.data.code!==0)throw new Error(`API Error: ${a.data.code}`);return!0}catch(a){return c(`${a}`),!1}finally{t.value=!1}},fetchMoveFiles:async()=>{let e=!0;if(e=await new Promise(a=>{z({title:"確定要上傳至暫存空間嗎？",message:"上傳後將覆蓋上傳空間所有檔案, 且無法復原",onOk:()=>{a(!0)},onCancel:()=>{a(!1)}})}),e){t.value=!0;try{const a=await o.api.moveDataToStashApiStashMovePost({name:l.value});if(!a)return;if(a.data.code!==0)throw new Error(`API Error: ${a.data.code}`);return S.value=!0,S.value&&await f(),!0}catch{return!1}finally{t.value=!1}}return!1},fetchStashOpenFolderPost:async e=>{t.value=!0;try{const a=await o.api.openFolderApiStashOpenFolderPost({name:e});if(!a)return;if(a.data.code!==0)throw new Error(`API Error: ${a.data.code}`)}catch(a){c(`${a}`)}finally{t.value=!1}},selectLocalFile:async()=>{let e=null;t.value=!0;try{const a=await o.api.selectLocalFileForPathApiStashSelectLocalFileForPathPost({});if(!a)return;if(a.data.code!==0)throw new Error(`API Error: ${a.data.code}`);const{result:r}=a.data;if(!r)return;e=r.file}catch(a){c(`${a}`)}finally{t.value=!1}return e}}});export{K as u};
