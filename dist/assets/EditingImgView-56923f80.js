import{y as be,h as he,b as u,i as Be,p as Le,C as xe,d as pe,o as m,c as k,a as n,ag as l,bI as o,bf as d,S as Z,b0 as de,a7 as Q,a8 as U,u as s,bM as z,af as h,B as we,bB as Fe,aN as je,aP as De,F as Ne,bC as Oe}from"./@vue-19632928.js";import"./base-23d00206.js";import{E as Te}from"./el-upload-5677c5b6.js";import"./el-progress-ed4e49af.js";import{E as Me}from"./el-dialog-f482d18c.js";import"./el-overlay-81162264.js";import{E as ee,a as Pe}from"./el-steps-c8cdef54.js";import{E as ve}from"./el-divider-67eeba91.js";import{a as We}from"./el-button-ded9ecc1.js";import{c as Qe}from"./el-main-e0dc383b.js";import{E as te}from"./el-checkbox-d46297b7.js";import{l as He,e as Ae,d as qe,g as Xe,o as Ye,p as Ze}from"./@element-plus-a8abf029.js";import{i as N,f as M,u as Ge,o as Ke}from"./index-d07dfee2.js";import{u as ye}from"./uploadFile-6ce60004.js";import{u as Je}from"./stashSpace-391fdb88.js";import{E as el,S as ll}from"./StashSelect-5af938b3.js";import{R as tl}from"./ResultImgWithStash-c075e0f0.js";import{d as al,r as me,w as ol,x as sl,v as nl,o as S,y as D,b as T,z as il,p as fe}from"./quasar-ff3737c6.js";/* empty css                        */import"./el-tooltip-4ed993c7.js";import{a as ce}from"./el-scrollbar-e3b486eb.js";import"./el-input-51d05b2a.js";import{E as ge}from"./el-input-number-815f9c07.js";/* empty css                */import{E as le,a as rl}from"./el-form-item-62aac1b2.js";/* empty css               */import{E as ul,a as pl}from"./el-select-99a9cb58.js";import{E as dl}from"./el-image-viewer-1a9f012d.js";import{_ as vl}from"./vue-cropperjs-119f6267.js";import"./cropperjs-18694e98.js";import{E as _e}from"./index-b8931eed.js";import{_ as ke}from"./json-editor-vue3-5344cb8d.js";import"./lodash-es-cc4652a2.js";import"./error-78e43d3e.js";import"./typescript-defaf979.js";import"./index-711061c4.js";import"./@vueuse-0d360189.js";import"./earthApi-baaacd65.js";import"./axios-439bb627.js";import"./use-dialog-b8544ca4.js";import"./event-9519ab40.js";import"./refs-e3a131a0.js";import"./vnode-18f2a975.js";import"./@ctrl-f8748455.js";import"./index-6127babd.js";import"./pinia-71cafef5.js";import"./vue-konva-50f8b9a5.js";import"./konva-364a8bb7.js";import"./@logicflow-db5a80c3.js";import"./vue-router-841924de.js";import"./vue-i18n-76143ed6.js";import"./@intlify-0ef9a929.js";import"./tiff.js-f0b72392.js";import"./jszip-0fc1db0a.js";import"./@quasar-a9c09e53.js";import"./validator-7d68535e.js";import"./el-alert-65b82b76.js";import"./el-card-a6aa41d5.js";import"./index-32075738.js";import"./async-validator-dee29e8b.js";import"./vue-45a73cbb.js";import"./jsoneditor-5f1e2c9e.js";const ml={class:"text-h6"},fl={class:"content"},cl={class:"tool"},gl={class:"actions"},bl={class:"img-info"},hl={class:"set-info"},wl={class:"actions"},yl={class:"cropper-area"},_l={class:"img-cropper"},kl={class:"preview-area"},$l=be({__name:"EditImg",props:{file:{type:Object,required:!0},setting:{type:Function,required:!0},url:{type:String,required:!0},fileType:{type:String,required:!0}},setup(ae){const B=ae,P=ye();he(()=>{i.value=B.fileType.split("/")[1]});const y=u(),v=u(),O=u(1),L=u(1),w=u(15),c=u(15),g=u(!0),C=u("#ffffff"),b=u(0),f=u(0),H=u(0),A=u(0),V=u(!1),I=u(0),x=u(0),F=u(!0),i=u("jpg"),p=[{value:"jpg",label:"jpg"},{value:"png",label:"png"},{value:"jpeg",label:"jpeg"},{value:"bmp",label:"bmp"},{value:"tiff",label:"tiff"}],r=u({}),_=()=>{O.value=-O.value,v.value.scaleX(O.value)},R=()=>{L.value=-L.value,v.value.scaleY(L.value)},G=Be(()=>({brightness:N.global.t("Brightness"),contrast:N.global.t("Contrast"),sharpness:N.global.t("Sharpness"),color:N.global.t("Color")})),E=Le({brightness:{value:1,min:.01,max:5,step:.01,switch:!1},contrast:{value:1,min:.01,max:5,step:.001,switch:!1},sharpness:{value:1,min:.01,max:5,step:.001,switch:!1},color:{value:1,min:.01,max:5,step:.001,switch:!1}}),$e=()=>{y.value=JSON.stringify(v.value.getData(),null,4);const{x:t,y:e,width:a,height:j,rotate:$,scaleX:Ie,scaleY:Re}=v.value.getData(),{brightness:ne,contrast:ie,sharpness:re,color:ue}=E,ze={x:t,y:e,crop_width:a,crop_height:j,rotate:$,scale_x:Ie,scale_y:Re,blank_border_color:g.value?C.value:"",is_resize:V.value,resize_width:I.value,resize_height:x.value,extension:i.value,brightness:ne.switch?ne.value:1,contrast:ie.switch?ie.value:1,sharpness:re.switch?re.value:1,color:ue.switch?ue.value:1};B.setting(ze)},oe=()=>{v.value.reset(),E.brightness.value=1,E.contrast.value=1,E.sharpness.value=1,E.color.value=1,Y(),se()},q=t=>{v.value.rotate(t)},X=t=>{v.value.relativeZoom(t)},K=t=>{switch(console.log("event.key",t.key),t.key){case"=":X(.2);break;case"-":X(-.2);break;case",":q(-c.value);break;case".":q(w.value);break;case"]":R();break;case"[":_();break;case"e":case"E":W.value=!W.value;break;case"r":case"R":oe();break}},Ce=()=>{const t=v.value.getData();b.value=Math.floor(t.width),f.value=Math.floor(t.height),r.value={data:t,img:v.value.getCroppedCanvas().toDataURL()},console.log("cropper.value =>",v.value),console.log("data =>",t)},se=()=>{const t=v.value.getData(),e=v.value.getImageData();b.value=Math.floor(t.width),f.value=Math.floor(t.height),H.value=e.naturalWidth,A.value=e.naturalHeight,window.addEventListener("keydown",K)};xe(()=>{window.removeEventListener("keydown",K)});const Ve=()=>{g.value=!0,C.value="#ffffff"},Ee=()=>{g.value?C.value="#ffffff":C.value="transparent"},Se=t=>{if(F.value&&t){const e=f.value/b.value;x.value=Math.floor(t*e)}},Ue=t=>{if(F.value&&t){const e=b.value/f.value;I.value=Math.floor(t*e)}};pe(V,()=>{V.value&&(I.value=b.value,x.value=f.value)});const J=u([]),Y=async()=>{const{brightness:t,contrast:e,sharpness:a,color:j}=E;await P.upload("/api/enhance_img",[B.file],{brightness:t.switch?t.value:1,contrast:e.switch?e.value:1,sharpness:a.switch?a.value:1,color:j.switch?j.value:1});const $=P.uploadResult;if($){if($.code!==0){M(`API Error: ${$.code}`);return}J.value=$.result.all_names}};Object.keys(E).forEach(t=>{pe(()=>E[t].switch,Y)});const W=u(!1);return(t,e)=>(m(),k(Z,null,[n("div",null,[l(nl,{modelValue:W.value,"onUpdate:modelValue":e[0]||(e[0]=a=>W.value=a),position:"right"},{default:o(()=>[l(al,null,{default:o(()=>[l(me,null,{default:o(()=>[n("div",ml,d(t.$t("ImgEnh")),1)]),_:1}),l(me,null,{default:o(()=>[(m(!0),k(Z,null,de(E,(a,j)=>(m(),k("div",{key:j},[l(ol,{modelValue:a.switch,"onUpdate:modelValue":$=>a.switch=$,label:G.value[j],onInput:Y,size:"24px"},null,8,["modelValue","onUpdate:modelValue","label"]),a.switch?(m(),Q(sl,{key:0,modelValue:a.value,"onUpdate:modelValue":$=>a.value=$,min:a.min,max:a.max,step:a.step,label:"","label-always":"",color:"light-green",onChange:Y},null,8,["modelValue","onUpdate:modelValue","min","max","step"])):U("",!0)]))),128)),l(s(dl),{src:J.value[0]??B.url,"preview-src-list":J.value,fit:"scale-down"},null,8,["src","preview-src-list"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),n("div",fl,[n("div",cl,[n("div",gl,[n("span",bl,[n("span",null,d(t.$t("ImgWidthHeight"))+": "+d(H.value)+" x "+d(A.value)+"px ",1),n("span",null,d(t.$t("CropWidthHeight"))+": "+d(b.value)+" x "+d(f.value)+" px ",1)]),n("span",hl,[l(s(rl),{"label-position":"left"},{default:o(()=>[l(s(le),{label:t.$t("Extension")},{default:o(()=>[l(s(ul),{modelValue:i.value,"onUpdate:modelValue":e[1]||(e[1]=a=>i.value=a),class:"m-2",placeholder:"Select",onChange:Ve},{default:o(()=>[(m(),k(Z,null,de(p,a=>l(s(pl),{key:a.value,label:a.label,value:a.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"]),i.value==="png"||i.value==="tiff"?(m(),Q(s(le),{key:0,class:"ml-3",label:t.$t("FillColor")},{default:o(()=>[l(s(te),{modelValue:g.value,"onUpdate:modelValue":e[2]||(e[2]=a=>g.value=a),onChange:Ee},null,8,["modelValue"])]),_:1},8,["label"])):U("",!0)]),_:1},8,["label"]),l(s(le),{label:t.$t("AdjustCroppedSize")},{default:o(()=>[l(s(te),{modelValue:V.value,"onUpdate:modelValue":e[3]||(e[3]=a=>V.value=a)},null,8,["modelValue"]),l(s(ge),{modelValue:I.value,"onUpdate:modelValue":e[4]||(e[4]=a=>I.value=a),class:"ml-3",min:0,step:1,disabled:!V.value,onChange:Se},null,8,["modelValue","disabled"]),e[15]||(e[15]=n("span",{class:"ml-3"}," x ",-1)),l(s(ge),{class:"ml-3",modelValue:x.value,"onUpdate:modelValue":e[5]||(e[5]=a=>x.value=a),min:0,step:1,disabled:!V.value,onChange:Ue},null,8,["modelValue","disabled"]),l(s(ce),{content:t.$t("AdjustWidthHeightProportionally"),placement:"top"},{default:o(()=>[l(s(el),{class:"ml-3",onClick:e[6]||(e[6]=()=>F.value=!F.value),underline:!1},{default:o(()=>[l(s(_e),{size:"large"},{default:o(()=>[F.value?(m(),Q(s(He),{key:0})):(m(),Q(s(Ae),{key:1}))]),_:1})]),_:1})]),_:1},8,["content"])]),_:1},8,["label"])]),_:1})])]),n("div",wl,[l(il,{push:""},{default:o(()=>[l(S,{onClick:e[7]||(e[7]=z(a=>X(.2),["prevent"])),push:"",size:"15px",icon:"zoom_in"},{default:o(()=>[l(D,null,{default:o(()=>[n("strong",null,d(t.$t("ZoomIn")),1),e[16]||(e[16]=h(" (")),l(T,{name:"add"}),e[17]||(e[17]=h(") "))]),_:1})]),_:1}),l(S,{onClick:e[8]||(e[8]=z(a=>X(-.2),["prevent"])),push:"",size:"15px",icon:"zoom_out"},{default:o(()=>[l(D,null,{default:o(()=>[n("strong",null,d(t.$t("ZoomOut")),1),e[18]||(e[18]=h(" (")),l(T,{name:"remove"}),e[19]||(e[19]=h(") "))]),_:1})]),_:1}),l(S,{onClick:z(_,["prevent"]),push:"",size:"15px",icon:"swap_horiz"},{default:o(()=>[l(D,null,{default:o(()=>[n("strong",null,d(t.$t("FlipHorizontal")),1),e[20]||(e[20]=h(" (【 ) "))]),_:1})]),_:1}),l(S,{onClick:z(R,["prevent"]),push:"",size:"15px",icon:"swap_vert"},{default:o(()=>[l(D,null,{default:o(()=>[n("strong",null,d(t.$t("FlipVertical")),1),e[21]||(e[21]=h(" ( 】) "))]),_:1})]),_:1})]),_:1}),l(s(ce),{content:t.$t("FillColor")},null,8,["content"]),l(fe,{modelValue:w.value,"onUpdate:modelValue":e[10]||(e[10]=a=>w.value=a),style:{width:"80px"},color:"primary",dense:""},{append:o(()=>[l(S,{onClick:e[9]||(e[9]=z(a=>q(w.value),["prevent"])),flat:""},{default:o(()=>[l(T,{name:"fa-solid fa-redo-alt"})]),_:1})]),default:o(()=>[l(D,null,{default:o(()=>[n("strong",null,d(t.$t("RotateClockwise")),1),e[22]||(e[22]=h(" (")),l(T,{name:"keyboard_arrow_right"}),e[23]||(e[23]=h(") "))]),_:1})]),_:1},8,["modelValue"]),l(fe,{modelValue:c.value,"onUpdate:modelValue":e[12]||(e[12]=a=>c.value=a),style:{width:"80px"},color:"primary",dense:""},{append:o(()=>[l(S,{onClick:e[11]||(e[11]=z(a=>q(-c.value),["prevent"])),flat:""},{default:o(()=>[l(T,{name:"fa-solid fa-undo-alt"})]),_:1})]),default:o(()=>[l(D,null,{default:o(()=>[n("strong",null,d(t.$t("RotateCounterClockwise")),1),e[24]||(e[24]=h(" (")),l(T,{name:"keyboard_arrow_left"}),e[25]||(e[25]=h(") "))]),_:1})]),_:1},8,["modelValue"]),n("div",null,[g.value?we((m(),k("input",{key:0,type:"color","onUpdate:modelValue":e[13]||(e[13]=a=>C.value=a)},null,512)),[[Fe,C.value]]):U("",!0),l(D,null,{default:o(()=>[n("strong",null,d(t.$t("FillColor")),1)]),_:1})]),l(S,{label:`${t.$t("ImgEnh")} (E)`,onClick:e[14]||(e[14]=a=>W.value=!0),color:"brown",glossy:""},null,8,["label"]),l(S,{onClick:z(oe,["prevent"]),flat:""},{default:o(()=>[h(d(t.$t("Button.Reset"))+" (R) ",1)]),_:1}),l(S,{onClick:z($e,["prevent"]),color:"primary",glossy:""},{default:o(()=>[h(d(t.$t("Setting")),1)]),_:1})])]),n("section",yl,[n("div",_l,[l(s(vl),{ref_key:"cropper",ref:v,src:B.url,"auto-crop-area":1,"min-container-width":330,"min-container-height":450,"zoom-on-wheel":!1,cropmove:Ce,ready:se,preview:".preview",onKeydown:K},null,8,["src"])])]),n("section",kl,[n("p",null,d(t.$t("Button.Preview")),1),n("div",{class:je(["preview",{"is-not-blank-border":!g.value}]),style:De({backgroundColor:g.value?C.value:"transparent"})},null,6)])])],64))}});const Cl=ke($l,[["__scopeId","data-v-294975ad"]]),Vl={class:"step-page"},El={class:"step-nav"},Sl={key:0},Ul={style:{display:"flex","flex-direction":"column"}},Il={key:0},Rl={class:"el-upload__tip"},zl={class:"el-upload__tip"},Bl=["src"],Ll={key:0,ref:"contentRef"},xl={key:0,class:"el-upload__tip text-red mb-3"},Fl={key:1},jl=be({__name:"EditingImgView",setup(ae){const B=Ge(),P=Je();he(()=>{console.log("EditingImgView")}),Ne(()=>{c.value[0]&&URL.revokeObjectURL(c.value[0])});const y=u(1),v=ye(),O=u(""),L=u(!1),w=u([]),c=u([]),g=u([]),C=u([]),b=u(!1),f=u(""),H=(i,p)=>{console.log(i,p)},A=i=>{O.value=i.url,L.value=!0},V=async()=>{await x()&&y.value++},I=async(i,p)=>{const _=new Tiff({buffer:i}).toCanvas(),R=await new Promise(G=>_.toBlob(G,p));return URL.createObjectURL(R)},x=async()=>{var p;let i="";if((p=c.value[0])!=null&&p.startsWith("blob:")&&URL.revokeObjectURL(c.value[0]),b.value){const[r]=P.spaceFileFirst||[];if(!r)return M(N.global.t("NoFile")),!1;if(!r.file_type.startsWith("image"))return M(N.global.t("NoImg")),!1;const R=await(await fetch(r.url)).arrayBuffer();f.value=r.file_type,i=f.value==="image/tiff"?await I(R,f.value):URL.createObjectURL(new Blob([R],{type:f.value})),w.value=[{name:r.filename,raw:new File([R],r.filename,{type:r.file_type})}]}else{const{raw:r}=w.value[0]||{};if(!r)return M(N.global.t("NoFile")),!1;f.value=r.type,i=f.value==="image/tiff"?await I(await r.arrayBuffer(),f.value):URL.createObjectURL(r)}return c.value=[i],!0},F=async i=>{const p=Ke();try{const r=i;b.value&&(r.folder_path=P.currentFolderPath),await v.upload("/api/editing_img",w.value,r);const _=v.uploadResult;if(!_)return;if(_.code!==0){M(`API Error: ${_.code}`);return}g.value=_.result.all_names,C.value=_.result.all_result_text,y.value++}catch(r){M(`${r}`)}finally{p.close()}};return(i,p)=>(m(),k(Z,null,[n("h4",null,d(i.$t("EditingImg")),1),l(s(ve)),n("div",Vl,[n("div",El,[l(s(Pe),{active:y.value,"finish-status":"success",class:"w3-margin-bottom",direction:s(B).lt.md?"horizontal":"vertical"},{default:o(()=>[l(s(ee),{title:i.$t("Upload"),icon:s(qe),onClick:p[0]||(p[0]=r=>(y.value=1,w.value=[],c.value=[],g.value=[])),class:"pointer"},null,8,["title","icon"]),l(s(ee),{title:i.$t("Setting"),icon:s(Xe),onClick:p[1]||(p[1]=r=>y.value=c.value.length>0?2:1),class:"pointer"},null,8,["title","icon"]),l(s(ee),{title:i.$t("Generate"),icon:s(Ye),onClick:p[2]||(p[2]=r=>y.value=g.value.length>0?3:2),class:"pointer"},null,8,["title","icon"])]),_:1},8,["active","direction"])]),l(s(Qe),null,{default:o(()=>[y.value===1?(m(),k("div",Sl,[l(s(We),{type:"success",onClick:p[3]||(p[3]=r=>V())},{default:o(()=>[h(d(i.$t("Upload")),1)]),_:1}),l(s(ve)),l(s(te),{modelValue:b.value,"onUpdate:modelValue":p[4]||(p[4]=r=>b.value=r)},{default:o(()=>[h(d(i.$t("Label.UsingTemporaryStorageSpace")),1)]),_:1},8,["modelValue"]),n("div",Ul,[b.value?(m(),k("div",Il,[l(ll,{"is-on-page":"","is-upload":"","get-first-file":""}),n("span",Rl,d(i.$t("UploadImg")),1)])):U("",!0)]),b.value?U("",!0):(m(),Q(s(Te),{key:0,class:"upload-drag-img","file-list":w.value,"onUpdate:fileList":p[5]||(p[5]=r=>w.value=r),action:"/api/api/editing_img","list-type":"picture-card","auto-upload":!1,"on-preview":A,"on-remove":H,accept:"image/jpeg, image/png, image/bmp, image/tiff",multiple:"",drag:""},{tip:o(()=>[n("div",zl,d(i.$t("UploadImg")),1)]),default:o(()=>[l(s(_e),null,{default:o(()=>[l(s(Ze))]),_:1})]),_:1},8,["file-list"])),l(s(Me),{modelValue:L.value,"onUpdate:modelValue":p[6]||(p[6]=r=>L.value=r)},{default:o(()=>[n("img",{"w-full":"",src:O.value,alt:"Preview Image"},null,8,Bl)]),_:1},8,["modelValue"])])):U("",!0),we(n("div",null,[c.value.length!==0?(m(),k("div",Ll,[l(Cl,{file:w.value[0],setting:F,url:c.value[0],"file-type":f.value},null,8,["file","url","file-type"]),b.value?(m(),k("div",xl,d(`${i.$t("Label.UsingTemporaryStorageSpace")}: ${i.$t("CheckFilesAreImages")}`),1)):U("",!0)],512)):U("",!0)],512),[[Oe,y.value===2]]),y.value===3&&g.value.length!==0?(m(),k("div",Fl,[l(tl,{all_names:g.value},null,8,["all_names"])])):U("",!0)]),_:1})])],64))}});const Ht=ke(jl,[["__scopeId","data-v-371e8287"]]);export{Ht as default};
