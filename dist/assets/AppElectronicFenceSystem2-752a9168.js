import{b as X,j as Oe}from"./quasar-ff3737c6.js";import{y as Me,b as g,d as Y,p as Z,F as Ge,h as Ue,i as ee,c as b,a as k,bf as z,ag as n,u as l,bI as u,a7 as _,a8 as $,B as Be,bC as Pe,S as P,o as d,b0 as ae,af as T,aN as Te}from"./@vue-19632928.js";import"./base-23d00206.js";import{a as q}from"./el-button-ded9ecc1.js";import{E as D,a as ve}from"./el-form-item-62aac1b2.js";/* empty css               */import{E as te,a as le}from"./el-select-99a9cb58.js";import"./el-scrollbar-e3b486eb.js";import{E as qe}from"./el-divider-67eeba91.js";import{E as re,a as We}from"./el-steps-c8cdef54.js";/* empty css                  */import{a as W}from"./el-main-e0dc383b.js";import{E as oe}from"./el-alert-65b82b76.js";/* empty css                */import{E as He}from"./el-image-viewer-1a9f012d.js";import{E as Qe}from"./el-slider-07e60acd.js";import"./el-input-51d05b2a.js";import"./el-input-number-815f9c07.js";import"./el-tooltip-4ed993c7.js";import{E as je,a as ge}from"./el-table-column-5047dc3a.js";import"./el-checkbox-d46297b7.js";import{u as xe,i as ie,o as N,f as w}from"./index-d07dfee2.js";import{u as Ke}from"./app_camera-ba436274.js";import{u as Je}from"./app_efs2-b194c67d.js";import{u as Xe}from"./weight-5b7ac0f0.js";import{a as Ye,g as Ze}from"./label-61e62ece.js";import{u as ea}from"./app_aoi_od-9abe0b5f.js";import{u as aa}from"./app_aoi_ad-0e4a855e.js";import{u as ta}from"./app_aoi_seg-13fc56b9.js";import{_ as la}from"./OdFilterSize.vue_vue_type_script_setup_true_lang-f38ed8d3.js";import{_ as ra}from"./SEGFilterSize.vue_vue_type_script_setup_true_lang-b9b2921a.js";import{_ as oa}from"./ADFilterSize.vue_vue_type_script_setup_true_lang-733b71be.js";import{_ as H,a as ia}from"./lodash-3dc9162a.js";import{_ as na}from"./json-editor-vue3-5344cb8d.js";import"./lodash-es-cc4652a2.js";import"./index-b8931eed.js";import"./@vueuse-0d360189.js";import"./index-711061c4.js";import"./@ctrl-f8748455.js";import"./error-78e43d3e.js";import"./async-validator-dee29e8b.js";import"./index-32075738.js";import"./earthApi-baaacd65.js";import"./axios-439bb627.js";import"./event-9519ab40.js";import"./index-6127babd.js";import"./vnode-18f2a975.js";import"./typescript-defaf979.js";import"./normalize-wheel-es-ed76fb12.js";import"./pinia-71cafef5.js";import"./vue-konva-50f8b9a5.js";import"./konva-364a8bb7.js";import"./@logicflow-db5a80c3.js";import"./vue-router-841924de.js";import"./vue-i18n-76143ed6.js";import"./@intlify-0ef9a929.js";import"./tiff.js-f0b72392.js";import"./jszip-0fc1db0a.js";import"./@quasar-a9c09e53.js";import"./decimal.js-d133ee8e.js";import"./ImgDetectionPartition-4a04bf44.js";import"./el-upload-5677c5b6.js";import"./el-progress-ed4e49af.js";import"./@element-plus-a8abf029.js";import"./KonvaPaint-e9087f28.js";import"./vue-drag-resize-6bf710ae.js";import"./el-switch-30a59a69.js";import"./validator-7d68535e.js";import"./jsoneditor-5f1e2c9e.js";const sa={class:"step-page"},ma={class:"step-nav"},ua={key:1},fa={key:0},da={class:"infer-content"},ca={class:"left"},pa={key:1},_a={key:2},c="poc-efs",va=Me({__name:"AppElectronicFenceSystem2",setup(ga){const V=xe(),C=Xe(),h=ta(),y=ea(),S=aa(),A=Ke(),O=Je(),o=g("OD");let M=g(!1);const we=g(),ne=g(),p=g(0),he=g([""]),I=g(""),Q=g(),se=g(0),me=g(0),ue=g(!1);Y(()=>I.value,async()=>{if(Q.value){se.value=0,me.value=0;const{width:e,height:a}=await Ze(I.value,Q);se.value=e,me.value=a}});const i=Z({model_name:"",cam_name:"",threshold:.7}),fe=Z({model_name:[{required:!0,message:ie.global.t("NoModelName"),trigger:"blur"}],cam_name:[{required:!0,message:ie.global.t("Label.PleaseSelect",{name:ie.global.t("Label.Camera")}),trigger:"blur"}]}),G=async()=>{const e=new Image;e.src=`/api/camera/frame?name=${i.cam_name}&t=${Date.now()}`,await new Promise((a,s)=>{e.onload=a,e.onerror=s}),I.value=e.src},ye=async()=>{o.value!==""&&i.model_name!==""&&p.value++},Se=async()=>{const e=N();try{const a={...i,name:c},f=await{OD:(t,m,E)=>y.startInfer(t,m,E),AD:()=>S.startInfer(i.cam_name,i.threshold,c,!0,"map_score"),SEG:(t,m,E)=>h.startInfer(t,m,E)}[o.value](a.cam_name,a.threshold,c);if(f!==0){w(`start od inference fail: ${f}`);return}M.value=!0,await j(),await O.initEfsModel(o.value,c),O.imgURL=I.value}catch(a){w(`start infer fail: ${a.message}`)}finally{e.close()}};Ge(()=>{var e;M.value=!1,(e=v.value)!=null&&e.load?localStorage.setItem("load_model",o.value):localStorage.removeItem("load_model")});const R=g(),be=async()=>{ue.value=!0;try{const e=await Ne();if(e!==0){w(`check efs poc info fail : ${e}`);return}}catch(e){w(`check efs poc info fail : ${e.message}`)}finally{ue.value=!1}},Ie=async({load:e,model_name:a,doing:s,cam_name:f,cls_w_h_a:t,cls_w_h:m,w_h_a:E,alert_area:x,filter_type:U,draw_alert_area:K})=>{var B;for(Fe(f),i.cam_name!==""&&await G(),await Ee(e,a,s),ke(a),$e(t,m,E,x,U,K);!R.value;)await new Promise(J=>setTimeout(J,1e3));console.log("load",e),a&&(await((B=R.value)==null?void 0:B.onChangeModelName(a,!1,e)),i.model_name=a),r.filter_type=U??"w_h",De()};Ue(async()=>{let e=0;const a=N();try{if(e=await A.loadCameraList(),e!==0&&w(`load camera list fail : ${e}`),!(v!=null&&v.value))return;const L=localStorage.getItem("load_model"),Ve=await O.getEfsModel(c);L&&(o.value=Ve||L),await C.getListdirs(o.value),console.log("load_model",L)}catch(L){w(`load camera list fail : ${L.message}`)}finally{a.close()}await be();const{load:s,doing:f,model_name:t,cam_name:m,cls_w_h:E,cls_w_h_a:x,w_h_a:U,alert_area:K,filter_type:B,draw_alert_area:J}=v.value;await Ie({load:s,model_name:t,doing:f,cam_name:m,cls_w_h_a:x,cls_w_h:E,w_h_a:U,alert_area:K,filter_type:B,draw_alert_area:J})});function Fe(e){var a,s;A.cameraList.length===0?i.cam_name="":((a=v.value)==null?void 0:a.cam_name)!==""&&~A.cameraList.findIndex(f=>f.name===e)?i.cam_name=(s=v.value)==null?void 0:s.cam_name:i.cam_name=A.cameraList[0].name}const Ee=async(e,a,s)=>{!e&&!a?p.value=0:p.value=1,s&&(M.value=!0,await j(),p.value=2)},ke=e=>{e&&(i.model_name=e)},$e=(e,a,s,f,t,m)=>{console.log("cls_w_h_a",e),console.log("cls_w_h",a),r.cls_w_h_a=H(e),r.cls_w_h=H(a),r.w_h_a=H(s),r.alert_area=H(f),r.filter_type=t??"w_h",r.draw_alert_area=m??!1},De=()=>{var e,a,s;r.alert_area&&((e=r.alert_area)==null?void 0:e.length)>0&&(r.isSizeFilter=!0,((a=r.alert_area)==null?void 0:a.length)>=2&&(r.isPartitionFilter=!0),((s=r.alert_area)==null?void 0:s.length)===1&&ia(r.alert_area[0],Ye).length>0&&(r.isPartitionFilter=!0))},r=Z({model_name:"",cls_w_h:[],cls_w_h_a:[],alert_area:[],isSizeFilter:!1,isPartitionFilter:!1,filter_type:"w_h",draw_alert_area:!1}),Ae=async e=>{await C.getListdirs(e),localStorage.setItem("load_model",e),i.model_name=C.modelList[0]??"",r.isSizeFilter=!1},de=async e=>{const a=N(),s=r.isSizeFilter?r.cls_w_h_a:void 0,f=r.isSizeFilter?r.alert_area:void 0,t=r.isSizeFilter?r.draw_alert_area:!1;try{const m=await h.init({model_name:i.model_name,cls_w_h_a:s,alert_area:f,filter_type:r.filter_type,isFinal:e,name:c,draw_alert_area:t});if(m!==0){w(`od poc model init fail : ${m}`);return}p.value=1}finally{a.close()}},ce=async e=>{const a=N();try{const s=r.isSizeFilter?r.cls_w_h:void 0,f=r.isSizeFilter?r.alert_area:void 0,t=r.isSizeFilter?r.draw_alert_area:!1,m=await y.init({model_name:i.model_name,crop_m:1,crop_n:1,cls_w_h:s,alert_area:f,isFinal:e,name:c,draw_alert_area:t});if(m!==0){w(`od poc model init fail : ${m}`);return}p.value=1}finally{a.close()}},pe=async e=>{const a=N();try{const s=r.isSizeFilter?r.w_h_a:void 0,f=r.isSizeFilter?r.alert_area:void 0,t=r.isSizeFilter?r.draw_alert_area:!1,m=await S.init({model_name:i.model_name,crop_m:1,crop_n:1,w_h_a:s,alert_area:f,isFinal:e,name:c,draw_alert_area:t});if(m!==0){w(`od poc model init fail : ${m}`);return}p.value=1}finally{a.close()}},Re=async()=>{o.value==="OD"?await ce(!0):o.value==="AD"?await pe(!0):o.value==="SEG"&&await de(!0),p.value=2},ze=async(e,a)=>{e&&await e.validate(async(s,f)=>{s?(console.log("submit!"),console.log(i),a&&await Se()):console.log("error submit!",f)})},v=ee(()=>o.value==="OD"?y.info:o.value==="AD"?S.info:o.value==="SEG"?h.info:null),F=ee(()=>o.value==="OD"?y.inferResult:o.value==="AD"?S.inferResult:o.value==="SEG"?h.inferResult:[]),_e=ee(()=>o.value==="OD"?y.imgURL:o.value==="AD"?S.imgURL:o.value==="SEG"?h.imgURL:""),Ce=async()=>{o.value==="OD"?await y.stopInfer(c):o.value==="AD"?await S.stopInfer(c):o.value==="SEG"&&await h.stopInfer(c),await O.initEfsModel("",c)},Le=async()=>o.value==="OD"?y.getInferResult(c):o.value==="AD"?S.getInferResult(c):o.value==="SEG"?h.getInferResult(c):0,Ne=async()=>o.value==="OD"?y.checkInfo(c):o.value==="AD"?S.checkInfo(c):o.value==="SEG"?h.checkInfo(c):0,j=async()=>{var e;if(!(!((e=v.value)!=null&&e.doing)||!M.value))try{const a=await Le();if(a!==0){w(`od inference result API Error : ${a}`);return}}finally{setTimeout(j,40)}};return Y(()=>p.value,async e=>{var a;e===1&&(await G(),(a=R.value)==null||a.handlePartLabel())}),Y(()=>i.cam_name,async e=>{e!==""&&await G()}),(e,a)=>{var s,f;return d(),b(P,null,[k("h4",null,z(e.$t("Dashboard.EFS2")),1),n(l(qe)),k("div",sa,[k("div",ma,[n(l(We),{active:p.value,"finish-status":"success",class:"w3-margin-bottom",direction:l(V).lt.md?"horizontal":"vertical"},{default:u(()=>[n(l(re),{title:e.$t("ModelSet"),class:"pointer",onClick:a[0]||(a[0]=()=>{var t;if((t=v.value)!=null&&t.doing){l(w)("Inference is running, please stop it first"),p.value=2;return}p.value=0})},{icon:u(()=>[n(X,{name:"fa-solid fa-gear",class:"w3-large"})]),_:1},8,["title"]),n(l(re),{title:e.$t("App.FenceSetting"),class:"pointer",onClick:a[1]||(a[1]=()=>{p.value=1})},{icon:u(()=>[n(X,{name:"fa-solid fa-gear",class:"w3-large"})]),_:1},8,["title"]),n(l(re),{title:e.$t("Inference"),class:"pointer"},{icon:u(()=>[n(X,{name:"fa-solid fa-brain",class:"w3-large"})]),_:1},8,["title"])]),_:1},8,["active","direction"])]),p.value===0?(d(),_(l(W),{key:0},{default:u(()=>[he.value.length===0?(d(),_(l(W),{key:0,style:{height:"10vh"}},{default:u(()=>[n(l(oe),{title:e.$t("NoWeight"),type:"warning",closable:!1,"show-icon":"",style:{"--el-alert-title-font-size":"1em"}},null,8,["title"])]),_:1})):(d(),_(l(W),{key:1},{default:u(()=>[n(l(ve),{ref_key:"ruleFormRef",ref:we,model:i,rules:fe,"label-position":"left",class:"demo-ruleForm","status-icon":""},{default:u(()=>[n(l(D),{label:e.$t("Label.Model")},{default:u(()=>[n(l(te),{modelValue:o.value,"onUpdate:modelValue":a[2]||(a[2]=t=>o.value=t),placeholder:"Select",onChange:a[3]||(a[3]=()=>Ae(o.value))},{default:u(()=>[(d(!0),b(P,null,ae(l(C).modelOptions.filter(t=>t.value==="OD"||t.value==="AD"||t.value==="SEG"),t=>(d(),_(l(le),{key:t.value,label:t.label,value:t.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1},8,["label"]),n(l(D),{label:e.$t("ModelName")},{default:u(()=>[n(l(te),{modelValue:i.model_name,"onUpdate:modelValue":a[4]||(a[4]=t=>i.model_name=t),onChange:a[5]||(a[5]=()=>{r.isSizeFilter=!1})},{default:u(()=>[(d(!0),b(P,null,ae(l(C).modelList,(t,m)=>(d(),_(l(le),{label:t,value:t,key:m},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1},8,["label"]),n(l(D),null,{default:u(()=>[n(l(q),{type:"primary",onClick:ye},{default:u(()=>[T(z(e.$t("ModelSet")),1)]),_:1})]),_:1})]),_:1},8,["model","rules"])]),_:1}))]),_:1})):$("",!0),Be(k("div",{class:"camera-settings",ref_key:"contentRef",ref:Q},[l(A).cameraList.length===0?(d(),_(l(oe),{key:0,type:"warning",title:e.$t("Hint.AddCameraFirst"),center:"","show-icon":"",closable:!1},null,8,["title"])):$("",!0),n(l(D),{label:e.$t("Button.Select",{name:e.$t("Label.Camera")})},{default:u(()=>[n(l(te),{modelValue:i.cam_name,"onUpdate:modelValue":a[6]||(a[6]=t=>i.cam_name=t),filterable:"","no-data-text":"No camera",placeholder:"No camera",onChange:a[7]||(a[7]=t=>G())},{default:u(()=>[(d(!0),b(P,null,ae(l(A).cameraList,(t,m)=>(d(),_(l(le),{label:`${t.name} (${t.cam_type==="cv"?t.src:t.cam_type})`,value:t.name,key:m},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1},8,["label"]),p.value===1&&i.cam_name!==""?(d(),b("div",ua,[o.value==="OD"?(d(),_(la,{key:0,formInfer:r,"onUpdate:formInfer":a[8]||(a[8]=t=>r=t),ref_key:"filterSizeRef",ref:R,initOD:ce,model_name:i.model_name,name:c,height:l(V).lt.md?"20vh":"25vh","img-url":I.value,"is-load":(s=v.value)==null?void 0:s.load,"show-draw-alert-area":""},null,8,["formInfer","model_name","height","img-url","is-load"])):$("",!0),o.value==="AD"?(d(),_(oa,{key:1,formInfer:r,"onUpdate:formInfer":a[9]||(a[9]=t=>r=t),ref_key:"filterSizeRef",ref:R,initAD:pe,model_name:i.model_name,name:c,height:l(V).lt.md?"20vh":"25vh","img-url":I.value,"show-draw-alert-area":""},null,8,["formInfer","model_name","height","img-url"])):$("",!0),o.value==="SEG"?(d(),_(ra,{key:2,formInfer:r,"onUpdate:formInfer":a[10]||(a[10]=t=>r=t),ref_key:"filterSizeRef",ref:R,initSEG:de,model_name:i.model_name,name:c,height:l(V).lt.md?"20vh":"25vh","img-url":I.value,"is-load":(f=v.value)==null?void 0:f.load,"show-draw-alert-area":""},null,8,["formInfer","model_name","height","img-url","is-load"])):$("",!0)])):$("",!0),n(l(D),null,{default:u(()=>[n(l(q),{type:"primary",onClick:Re},{default:u(()=>[T(z(e.$t("App.FenceSetting")),1)]),_:1})]),_:1})],512),[[Pe,p.value===1]]),p.value===2?(d(),_(l(W),{key:1},{default:u(()=>{var t;return[(t=v.value)!=null&&t.doing?(d(),b("div",fa,[n(l(q),{type:"danger",onClick:a[11]||(a[11]=m=>Ce())},{default:u(()=>[T(z(e.$t("Button.Stop",{name:e.$t("Inference")})),1)]),_:1}),k("div",da,[k("div",ca,[F.value&&typeof F.value!="string"?(d(),_(l(je),{key:0,data:F.value},{default:u(()=>[n(l(ge),{prop:"label",label:"Label","min-width":80}),n(l(ge),{prop:"number",label:"Number","min-width":100})]),_:1},8,["data"])):typeof F.value=="string"?(d(),b("div",pa,[n(Oe,{label:"Inference Result",class:"q-mb-md"},{default:u(()=>[k("p",{class:Te(["text-h4",{"text-negative":F.value==="NG","text-positive":F.value==="OK"}])},z(F.value),3)]),_:1})])):(d(),b("div",_a,[n(l(oe),{title:"No Inference Result",type:"warning",center:"","show-icon":"",closable:!1})]))]),n(l(He),{src:_e.value,"preview-src-list":[_e.value],fit:"fill",style:{height:"100%","max-height":"800px","max-width":"1000px"}},null,8,["src","preview-src-list"])])])):(d(),_(l(ve),{key:1,ref_key:"inferFormRef",ref:ne,model:i,rules:fe,"label-width":"100px","label-position":"left",class:"demo-ruleForm","status-icon":""},{default:u(()=>[n(l(D),{label:e.$t("Threshold")},{default:u(()=>[n(l(Qe),{modelValue:i.threshold,"onUpdate:modelValue":a[12]||(a[12]=m=>i.threshold=m),min:.1,max:1,step:.01,style:{width:"600px"}},null,8,["modelValue"])]),_:1},8,["label"]),n(l(D),null,{default:u(()=>[n(l(q),{type:"primary",onClick:a[13]||(a[13]=m=>ze(ne.value,!0)),disabled:i.cam_name===""},{default:u(()=>[T(z(e.$t("Button.Start",{name:e.$t("Inference")})),1)]),_:1},8,["disabled"])]),_:1})]),_:1},8,["model","rules"]))]}),_:1})):$("",!0)])],64)}}});const Lt=na(va,[["__scopeId","data-v-83cfc46d"]]);export{Lt as default};
